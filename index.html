<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF → GAS 測試最小表單</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h3>最小表單（GitHub → GAS）</h3>

  <div id="me">載入中…</div>

  <div>
    <label>所屬單位：
      <select id="group">
        <option value="" selected disabled>請選擇</option>
        <option>長定組</option>
        <option>慈助會</option>
      </select>
    </label>
  </div>

  <div>
    <label>施助名單1：<input id="name1" /></label>
    <label>施助名單2：<input id="name2" /></label>
    <label>施助名單3：<input id="name3" /></label>
    <label>施助名單4：<input id="name4" /></label>
  </div>

  <button id="send" disabled>送出</button>
  <p id="status">尚未送出</p>

  <script>
    // ← 換成你的 LIFF App ID 與 GAS exec 網址
    const LIFF_ID = '2008163833-WOE8qe5b';
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwf8sf0Ll9i33m46qBRtBbLJ6yN-xwol90fLf4Zn553j3KnSKgekggq9KIqw2ZFLhEm/exec';

    const el = (id) => document.getElementById(id);
    const S = el('status');

    // 這些值會在 init 後填好
    const me = { display_name: '', liff_user_id: '', idtoken_sub: '' };

    (async () => {
      try {
        S.textContent = '初始化 LIFF…';
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        if (!liff.isLoggedIn()) return liff.login({ redirectUri: location.href });

        const decoded = liff.getDecodedIDToken?.() || {};
        me.idtoken_sub = decoded.sub || '';

        const profile = await liff.getProfile();
        me.display_name = profile?.displayName || '';
        me.liff_user_id = profile?.userId || '';

        el('me').textContent = `你是：${me.display_name} (${me.liff_user_id || '無 userId'})`;
        el('send').disabled = false;
        S.textContent = '就緒';
      } catch (e) {
        S.textContent = 'LIFF 初始化失敗：' + (e.message || e);
        console.error(e);
      }
    })();

    el('send').addEventListener('click', async () => {
      const payload = {
        group: el('group').value,
        names: [el('name1').value, el('name2').value, el('name3').value, el('name4').value]
          .map(s => (s||'').trim()).filter(Boolean),
        display_name: me.display_name,
        liff_user_id: me.liff_user_id,
        idtoken_sub: me.idtoken_sub,
        submitted_at: new Date().toISOString()
      };

      if (!payload.group) { S.textContent = '請選擇所屬單位'; return; }
      if (payload.names.length === 0) { S.textContent = '至少填 1 筆名單'; return; }

      S.textContent = '送出中…';
      try {
        // ★ 重點：no-cors（前端拿不到回應是正常的）
        await fetch(GAS_ENDPOINT, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        S.textContent = '已送出（前端無法讀回應，請到 Sheet 查）';
      } catch (e) {
        S.textContent = '送出失敗：' + (e.message || e);
      }
    });
  </script>
</body>
</html>
